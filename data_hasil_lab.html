<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Hasil Lab - Rumah Sakit Imanuel</title>
  <link rel="stylesheet" href="style2.css">
  <style>
    /* Anda bisa memindahkan gaya ini ke file style2.css jika mau */
    #cancelBtn {
        background-color: #7f8c8d;
        margin-top: 10px;
    }
    #cancelBtn:hover {
        background-color: #95a5a6;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Selamat Datang di Rumah Sakit Imanuel</h1>
  </div>

  <div class="navigation-bar">
    <a href="index.html" class="navbar-logo">RS Imanuel</a>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="data_pasien.html">Data Pasien</a></li>
      <li><a href="periksa.html">Jenis Pemeriksaan</a></li>
      <li><a href="data_hasil_lab.html">Input Hasil Lab</a></li>
    </ul>
  </div>

  <div class="container" id="formContainer">
    <h1 class="page-title" id="input-header">Input Data Hasil Lab</h1>
    <div class="main-controls">
      <label for="pasienSelect">Nama Pasien:</label>
      <select id="pasienSelect">
        <option value="">-- Pilih Pasien --</option>
      </select>
      <input type="hidden" id="pasienIdHidden">
    </div>

    <div id="formInput">
      <div id="hemogoblinGroup" class="form-group hidden"><label for="hemogoblin">Hemoglobin:</label><input type="number" id="hemogoblin" step="0.01"></div>
      <div id="hematokritGroup" class="form-group hidden"><label for="hematokrit">Hematokrit:</label><input type="number" id="hematokrit" step="0.01"></div>
      <div id="leukositGroup" class="form-group hidden"><label for="leukosit">Leukosit:</label><input type="number" id="leukosit"></div>
      <div id="eritrositGroup" class="form-group hidden"><label for="eritrosit">Eritrosit:</label><input type="number" id="eritrosit" step="0.01"></div>
      <div id="trombositGroup" class="form-group hidden"><label for="trombosit">Trombosit:</label><input type="number" id="trombosit"></div>
      <div id="ledGroup" class="form-group hidden"><label for="led">LED:</label><input type="number" id="led"></div>
      <div id="retikulositGroup" class="form-group hidden"><label for="retikulosit">Retikulosit:</label><input type="number" id="retikulosit" step="0.1"></div>
      <div id="sgotGroup" class="form-group hidden"><label for="sgot">SGOT (AST):</label><input type="number" id="sgot"></div>
      <div id="sgptGroup" class="form-group hidden"><label for="sgpt">SGPT (ALT):</label><input type="number" id="sgpt"></div>
      <div id="bilirubinGroup" class="form-group hidden"><label for="bilirubin">Bilirubin Total:</label><input type="number" id="bilirubin" step="0.01"></div>
      <div id="ureumGroup" class="form-group hidden"><label for="ureum">Ureum:</label><input type="number" id="ureum"></div>
      <div id="creatinineGroup" class="form-group hidden"><label for="creatinine">Creatinine:</label><input type="number" id="creatinine" step="0.01"></div>
      <div id="HbsAGGroup" class="form-group hidden"><label for="HbsAG">HbsAG:</label><input type="text" id="HbsAG"></div>
      <div id="antiHbsGroup" class="form-group hidden"><label for="antiHbs">Anti HBs:</label><input type="text" id="antiHbs"></div>
      <div id="antiHcvGroup" class="form-group hidden"><label for="antiHcv">Anti HCV:</label><input type="text" id="antiHcv"></div>
      <div id="urineGroup" class="form-group hidden"><label for="urine">Urine Lengkap:</label><textarea id="urine" rows="4"></textarea></div>

      <button id="saveBtn" class="hidden">Simpan Hasil Lab</button>
      <button id="cancelBtn" class="hidden">Batal</button>
    </div>
  </div>

  <div class="patient-data-container">
    <div class="table-header">
      <h2 class="section-title">Data Hasil Lab Pasien</h2>
      <div class="search-container">
        <input type="search" id="searchInput" placeholder="Cari nama pasien...">
        <button id="searchButton">Cari</button>
      </div>
    </div>
  </div>
  <div id="hasilLabTable">
    <table>
      <thead>
        <tr>
          <th>Nama Pasien</th>
          <th class="sortable" data-sort="tanggal">Tanggal Periksa â‡µ</th>
          <th>Dokter Pengirim</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="hasilLabList"></tbody>
    </table>
  </div>

  <script>
    const DOM = {
        pasienSelect: document.getElementById('pasienSelect'),
        pasienIdHidden: document.getElementById('pasienIdHidden'),
        saveBtn: document.getElementById('saveBtn'),
        cancelBtn: document.getElementById('cancelBtn'),
        hasilLabList: document.getElementById('hasilLabList'),
        searchInput: document.getElementById('searchInput'),
        searchButton: document.getElementById('searchButton'),
    };
    let currentSort = { key: 'tanggal', order: 'desc' };

    function getAllPatients() { return JSON.parse(localStorage.getItem('pasienList')) || []; }
    function saveAllPatients(pasienList) { localStorage.setItem('pasienList', JSON.stringify(pasienList)); }
    function handlePrint(pasienId) { window.open(`print.html?id=${pasienId}`, '_blank'); }

    // render tabel hasil lab
    function renderTable() {
        const searchTerm = DOM.searchInput.value.toLowerCase();
        let pasienDenganHasil = getAllPatients().filter(p => p.hasilLab && Object.keys(p.hasilLab).length > 0);
        if (searchTerm) pasienDenganHasil = pasienDenganHasil.filter(p => p.nama.toLowerCase().includes(searchTerm));
        pasienDenganHasil.sort((a, b) => {
            const dateA = new Date(a[currentSort.key]); const dateB = new Date(b[currentSort.key]);
            return currentSort.order === 'asc' ? dateA - dateB : dateB - dateA;
        });
        DOM.hasilLabList.innerHTML = '';
        if (pasienDenganHasil.length === 0) {
            DOM.hasilLabList.innerHTML = '<tr><td colspan="4" style="text-align:center;">Data tidak ditemukan.</td></tr>'; return;
        }
        pasienDenganHasil.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${p.nama}</td><td>${p.tanggal||'-'}</td><td>${p.dokter_pengirim||'-'}</td>
                            <td><button onclick="handleEdit(${p.id})">Edit</button><button onclick="handlePrint(${p.id})">Cetak</button></td>`;
            DOM.hasilLabList.appendChild(row);
        });
    }

    // siapkan form input
    function siapkanForm(pasien, testsToShow, prefillData = {}) {
        DOM.pasienSelect.value = pasien.id;
        DOM.pasienIdHidden.value = pasien.id;
        document.querySelectorAll('.form-group').forEach(group => {
            group.classList.add('hidden');
        });
        testsToShow.forEach(testId => {
            const group = document.getElementById(`${testId}Group`);
            const input = document.getElementById(testId);
            if (group && input) {
                group.classList.remove('hidden');
                input.value = prefillData[testId] || '';
            }
        });
        DOM.saveBtn.classList.remove('hidden'); 
        DOM.cancelBtn.classList.remove('hidden');
        document.getElementById('input-header').scrollIntoView({ behavior: 'smooth' });
    }

    function handleEdit(pasienId) {
        const pasien = getAllPatients().find(p => p.id === pasienId);
        if (pasien && pasien.hasilLab) {
            const existingTests = Object.keys(pasien.hasilLab);
            siapkanForm(pasien, existingTests, pasien.hasilLab);
            DOM.saveBtn.textContent = 'Update Hasil Lab';
        }
    }

    function handleSave() {
        const pasienId = parseInt(DOM.pasienIdHidden.value);
        if (!pasienId) return alert('Silakan pilih pasien terlebih dahulu!');
        const pasienList = getAllPatients();
        const pasienIndex = pasienList.findIndex(p => p.id === pasienId);
        if (pasienIndex === -1) return alert('Pasien tidak ditemukan!');
        let hasilLab = pasienList[pasienIndex].hasilLab || {};
        document.querySelectorAll('.form-group:not(.hidden)').forEach(group => {
            const input = group.querySelector('input, textarea'); 
            if (input) input.value ? hasilLab[input.id]=input.value : delete hasilLab[input.id];
        });
        // hitung tambahan
        const hb=parseFloat(hasilLab.hemogoblin),ht=parseFloat(hasilLab.hematokrit),er=parseFloat(hasilLab.eritrosit);
        if(!isNaN(ht)&&!isNaN(er)&&er>0)hasilLab.MCV=(ht*10/er).toFixed(2);
        if(!isNaN(hb)&&!isNaN(er)&&er>0)hasilLab.MCH=(hb*10/er).toFixed(2);
        if(!isNaN(hb)&&!isNaN(ht)&&ht>0)hasilLab.MCHC=(hb*100/ht).toFixed(2);
        pasienList[pasienIndex].hasilLab = hasilLab; saveAllPatients(pasienList);
        alert('Data hasil lab berhasil disimpan/diupdate!'); window.location.reload();
    }

    function populatePatientDropdown() {
        const pasienList = getAllPatients();
        DOM.pasienSelect.innerHTML = '<option value="">-- Pilih Pasien --</option>';
        pasienList.forEach(p => {
            const option=document.createElement('option'); option.value=p.id; option.textContent=p.nama; DOM.pasienSelect.appendChild(option);
        });
        DOM.pasienSelect.addEventListener('change', () => {
            const pasienId = parseInt(DOM.pasienSelect.value);
            DOM.pasienIdHidden.value = pasienId || "";
            if (pasienId) {
                const pasien = getAllPatients().find(p => p.id === pasienId);
                const dataPemeriksaan = JSON.parse(localStorage.getItem('pemeriksaanUntukDiinput'));
                if (dataPemeriksaan && dataPemeriksaan.pasienId === pasienId) {
                    siapkanForm(pasien, dataPemeriksaan.tests);
                    DOM.saveBtn.textContent = 'Simpan Hasil Lab Baru';
                    localStorage.removeItem('pemeriksaanUntukDiinput');
                } else if (pasien.hasilLab) {
                    const existingTests = Object.keys(pasien.hasilLab);
                    siapkanForm(pasien, existingTests, pasien.hasilLab);
                    DOM.saveBtn.textContent = 'Update Hasil Lab';
                }
            }
        });
    }

    // [PERUBAHAN] Fungsi untuk handle scroll navbar ditambahkan di sini
    function handleNavbarScroll() {
      const navbar = document.querySelector(".navigation-bar");
      if (window.scrollY > 50) {
        navbar.classList.add("scrolled");
      } else {
        navbar.classList.remove("scrolled");
      }
    }

    function initializeApp() {
        populatePatientDropdown();
        const dataDariPemeriksaan = JSON.parse(localStorage.getItem('pemeriksaanUntukDiinput'));
        if (dataDariPemeriksaan) {
            const pasien = getAllPatients().find(p => p.id === dataDariPemeriksaan.pasienId);
            if (pasien) {
                DOM.pasienSelect.value = pasien.id;
                DOM.pasienIdHidden.value = pasien.id;
                siapkanForm(pasien, dataDariPemeriksaan.tests);
                DOM.saveBtn.textContent = 'Simpan Hasil Lab Baru';
            }
            localStorage.removeItem('pemeriksaanUntukDiinput');
        }
        DOM.searchButton.addEventListener('click', renderTable);
        DOM.searchInput.addEventListener('keyup', e=>{ if(e.key==='Enter') renderTable(); });
        DOM.saveBtn.addEventListener('click', handleSave);
        DOM.cancelBtn.addEventListener('click', ()=>{ if(confirm('Batalkan perubahan?')) window.location.reload(); });
        document.querySelectorAll('#hasilLabTable th.sortable').forEach(header=>{
            header.addEventListener('click',()=>{ const sortKey=header.getAttribute('data-sort');
                currentSort.order=(currentSort.key===sortKey&&currentSort.order==='desc')?'asc':'desc';
                currentSort.key=sortKey; renderTable(); });
        });

        // [PERUBAHAN] Event listener untuk scroll ditambahkan di sini
        window.addEventListener("scroll", handleNavbarScroll);
        
        renderTable();
    }
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>