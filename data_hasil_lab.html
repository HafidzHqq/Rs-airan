<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Hasil Lab - Rumah Sakit Imanuel</title>
  <link rel="stylesheet" href="style2.css">
</head>
<body>
  <div class="header">
    <h1>Selamat Datang di Rumah Sakit Imanuel</h1>
  </div>

  <div class="navigation-bar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="data_pasien.html">Data Pasien</a></li>
      <li><a href="data_hasil_lab.html">Data Hasil Lab</a></li>
    </ul>
  </div>
  <br><br>

  <h1>Input Data Hasil Lab</h1>

  <label for="pasienSelect">Pilih Pasien:</label>
  <select id="pasienSelect"></select>

  <!-- Form input dibungkus dengan id="formInput" -->
  <div class="form" id="formInput">
    <label for="hemogoblin">Hemoglobin:</label>
    <input type="number" id="hemogoblin" step="0.01">

    <label for="hematokrit">Hematokrit:</label>
    <input type="number" id="hematokrit" step="0.01">

    <label for="leukosit">Leukosit:</label>
    <input type="number" id="leukosit">

    <label for="eritrosit">Eritrosit:</label>
    <input type="number" id="eritrosit" step="0.01">

    <label for="trombosit">Trombosit:</label>
    <input type="number" id="trombosit">

    <label for="HbsAG">HbsAG:</label>
    <input type="text" id="HbsAG">

    <label for="AST">AST:</label>
    <input type="number" id="AST">

    <label for="ALT">ALT:</label>
    <input type="number" id="ALT">

    <button onclick="simpanHasilLab()">Simpan Hasil Lab</button>
  </div>

  <br>

  <h2>Data Hasil Lab Pasien</h2>
  <table border="1">
    <thead>
      <tr>
        <th>Nama</th>
        <th>Hemoglobin</th>
        <th>Hematokrit</th>
        <th>Leukosit</th>
        <th>Eritrosit</th>
        <th>Trombosit</th>
        <th>HbsAG</th>
        <th>MCH</th>
        <th>MCHC</th>
        <th>MCV</th>
        <th>AST</th>
        <th>ALT</th> 
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="hasilLabList"></tbody>
  </table>

  <script>
    let editPasienId = null;

    function loadPasienDropdown() {
      let pasienList = JSON.parse(localStorage.getItem('pasienList')) || [];
      let pasienSelect = document.getElementById('pasienSelect');
      pasienSelect.innerHTML = "";

      pasienList.forEach(p => {
        let option = document.createElement("option");
        option.value = p.id;
        option.textContent = `${p.nama} (ID: ${p.id})`;
        pasienSelect.appendChild(option);
      });
    }

    function simpanHasilLab() {
      let pasienList = JSON.parse(localStorage.getItem('pasienList')) || [];

      let pasienId = editPasienId 
        ? editPasienId 
        : parseInt(document.getElementById("pasienSelect").value);

      let pasien = pasienList.find(p => p.id === pasienId);
      if (!pasien) {
        alert("Pasien tidak ditemukan!");
        return;
      }

      // ambil nilai input
      let hemogoblin = parseFloat(document.getElementById("hemogoblin").value) || 0;
      let hematokrit = parseFloat(document.getElementById("hematokrit").value) || 0;
      let leukosit = parseFloat(document.getElementById("leukosit").value) || 0;
      let eritrosit = parseFloat(document.getElementById("eritrosit").value) || 0;
      let trombosit = parseFloat(document.getElementById("trombosit").value) || 0;
      let HbsAG = document.getElementById("HbsAG").value || "-";
      let AST = document.getElementById("AST").value || "-";
      let ALT = document.getElementById("ALT").value || "-";

      // hitung otomatis MCV, MCH, MCHC
      let MCV = eritrosit > 0 ? (hematokrit * 10 / eritrosit).toFixed(2) : 0;
      let MCH = eritrosit > 0 ? (hemogoblin * 10 / eritrosit).toFixed(2) : 0;
      let MCHC = hematokrit > 0 ? (hemogoblin * 100 / hematokrit).toFixed(2) : 0;

      // simpan ke pasien
      pasien.hemogoblin = hemogoblin;
      pasien.hematokrit = hematokrit;
      pasien.leukosit = leukosit;
      pasien.eritrosit = eritrosit;
      pasien.trombosit = trombosit;
      pasien.HbsAG = HbsAG;
      pasien.MCV = MCV;
      pasien.MCH = MCH;
      pasien.MCHC = MCHC;
      pasien.AST = AST;
      pasien.ALT = ALT;

      localStorage.setItem('pasienList', JSON.stringify(pasienList));

      alert(editPasienId ? "Hasil lab berhasil diperbarui!" : "Hasil lab berhasil disimpan!");
      editPasienId = null;
      tampilkanHasilLab();

      // reset form
      document.getElementById("hemogoblin").value = "";
      document.getElementById("hematokrit").value = "";
      document.getElementById("leukosit").value = "";
      document.getElementById("eritrosit").value = "";
      document.getElementById("trombosit").value = "";
      document.getElementById("HbsAG").value = "";
      document.getElementById("AST").value = "";
      document.getElementById("ALT").value = "";
    }

    function cetakPasien(pasienId) {
      window.open("print.html?id=" + pasienId, "_blank");
    }

    function editPasien(pasienId) {
      let pasienList = JSON.parse(localStorage.getItem('pasienList')) || [];
      let pasien = pasienList.find(p => p.id === pasienId);
      if (!pasien) {
        alert("Pasien tidak ditemukan!");
        return;
      }

      document.getElementById("pasienSelect").value = pasien.id;
      document.getElementById("hemogoblin").value = pasien.hemogoblin || "";
      document.getElementById("hematokrit").value = pasien.hematokrit || "";
      document.getElementById("leukosit").value = pasien.leukosit || "";
      document.getElementById("eritrosit").value = pasien.eritrosit || "";
      document.getElementById("trombosit").value = pasien.trombosit || "";
      document.getElementById("HbsAG").value = pasien.HbsAG || "";
      document.getElementById("AST").value = pasien.AST || "";
      document.getElementById("ALT").value = pasien.ALT || "";

      editPasienId = pasien.id; 

      // otomatis scroll ke form input
      document.getElementById("formInput").scrollIntoView({ behavior: "smooth" });
    }

    function tampilkanHasilLab() {
      let pasienList = JSON.parse(localStorage.getItem('pasienList')) || [];
      let hasilLabList = document.getElementById("hasilLabList");
      hasilLabList.innerHTML = "";

      pasienList.forEach(p => {
        let row = document.createElement("tr");
        row.innerHTML = `
          <td>${p.nama}</td>
          <td>${p.hemogoblin || "-"}</td>
          <td>${p.hematokrit || "-"}</td>
          <td>${p.leukosit || "-"}</td>
          <td>${p.eritrosit || "-"}</td>
          <td>${p.trombosit || "-"}</td>
          <td>${p.HbsAG || "-"}</td>
          <td>${p.MCH || "-"}</td>
          <td>${p.MCHC || "-"}</td>
          <td>${p.MCV || "-"}</td>
          <td>${p.AST || "-"}</td>
          <td>${p.ALT || "-"}</td>
          <td>
            <button onclick="cetakPasien(${p.id})">Cetak</button>
            <button onclick="editPasien(${p.id})">Edit</button>
          </td>
        `;
        hasilLabList.appendChild(row);
      });
    }

    window.onload = function() {
      loadPasienDropdown();
      tampilkanHasilLab();
    }
  </script>
</body>
</html>
