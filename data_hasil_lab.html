<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Hasil Lab - Rumah Sakit Imanuel</title>
  <link rel="stylesheet" href="style2.css">
</head>
<body>
  <div class="header">
    <h1>Selamat Datang di Rumah Sakit Imanuel</h1>
  </div>

  <div class="navigation-bar">
    <a href="index.html" class="navbar-logo">RS Imanuel</a>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="data_pasien.html">Data Pasien</a></li>
      <li><a href="data_hasil_lab.html">Data Hasil Lab</a></li>
    </ul>
  </div>

  <div class="container">
    <h1 class="page-title" id="input-header">Input Data Hasil Lab</h1>

    <div class="main-controls">
      <label for="pasienSelect">Pilih Pasien:</label>
      <select id="pasienSelect"></select>
    </div>

    <h3>Pilih Pemeriksaan yang Akan Diinput:</h3>
    <div id="pemeriksaanList">
      <label><input type="checkbox" onchange="toggleInput('hemogoblinGroup'); toggleSaveButton();"> Hemoglobin</label>
      <label><input type="checkbox" onchange="toggleInput('hematokritGroup'); toggleSaveButton();"> Hematokrit</label>
      <label><input type="checkbox" onchange="toggleInput('leukositGroup'); toggleSaveButton();"> Leukosit</label>
      <label><input type="checkbox" onchange="toggleInput('eritrositGroup'); toggleSaveButton();"> Eritrosit</label>
      <label><input type="checkbox" onchange="toggleInput('trombositGroup'); toggleSaveButton();"> Trombosit</label>
      <label><input type="checkbox" onchange="toggleInput('ledGroup'); toggleSaveButton();"> LED</label>
      <label><input type="checkbox" onchange="toggleInput('retikulositGroup'); toggleSaveButton();"> Retikulosit</label>
      <label><input type="checkbox" onchange="toggleInput('sgotGroup'); toggleSaveButton();"> SGOT (AST)</label>
      <label><input type="checkbox" onchange="toggleInput('sgptGroup'); toggleSaveButton();"> SGPT (ALT)</label>
      <label><input type="checkbox" onchange="toggleInput('bilirubinGroup'); toggleSaveButton();"> Bilirubin Total</label>
      <label><input type="checkbox" onchange="toggleInput('ureumGroup'); toggleSaveButton();"> Ureum</label>
      <label><input type="checkbox" onchange="toggleInput('creatinineGroup'); toggleSaveButton();"> Creatinine</label>
      <label><input type="checkbox" onchange="toggleInput('HbsAGGroup'); toggleSaveButton();"> HbsAG</label>
      <label><input type="checkbox" onchange="toggleInput('antiHbsGroup'); toggleSaveButton();"> Anti HBs</label>
      <label><input type="checkbox" onchange="toggleInput('antiHcvGroup'); toggleSaveButton();"> Anti HCV</label>
      <label><input type="checkbox" onchange="toggleInput('urineGroup'); toggleSaveButton();"> Urine Lengkap</label>
    </div>

    <div id="formInput">
      <div id="hemogoblinGroup" class="form-group hidden"><label for="hemogoblin">Hemoglobin:</label><input type="number" id="hemogoblin" step="0.01"></div>
      <div id="hematokritGroup" class="form-group hidden"><label for="hematokrit">Hematokrit:</label><input type="number" id="hematokrit" step="0.01"></div>
      <div id="leukositGroup" class="form-group hidden"><label for="leukosit">Leukosit:</label><input type="number" id="leukosit"></div>
      <div id="eritrositGroup" class="form-group hidden"><label for="eritrosit">Eritrosit:</label><input type="number" id="eritrosit" step="0.01"></div>
      <div id="trombositGroup" class="form-group hidden"><label for="trombosit">Trombosit:</label><input type="number" id="trombosit"></div>
      <div id="ledGroup" class="form-group hidden"><label for="led">LED:</label><input type="number" id="led"></div>
      <div id="retikulositGroup" class="form-group hidden"><label for="retikulosit">Retikulosit:</label><input type="number" id="retikulosit" step="0.1"></div>
      <div id="sgotGroup" class="form-group hidden"><label for="sgot">SGOT (AST):</label><input type="number" id="sgot"></div>
      <div id="sgptGroup" class="form-group hidden"><label for="sgpt">SGPT (ALT):</label><input type="number" id="sgpt"></div>
      <div id="bilirubinGroup" class="form-group hidden"><label for="bilirubin">Bilirubin Total:</label><input type="number" id="bilirubin" step="0.01"></div>
      <div id="ureumGroup" class="form-group hidden"><label for="ureum">Ureum:</label><input type="number" id="ureum"></div>
      <div id="creatinineGroup" class="form-group hidden"><label for="creatinine">Creatinine:</label><input type="number" id="creatinine" step="0.01"></div>
      <div id="HbsAGGroup" class="form-group hidden"><label for="HbsAG">HbsAG:</label><input type="text" id="HbsAG"></div>
      <div id="antiHbsGroup" class="form-group hidden"><label for="antiHbs">Anti HBs:</label><input type="text" id="antiHbs"></div>
      <div id="antiHcvGroup" class="form-group hidden"><label for="antiHcv">Anti HCV:</label><input type="text" id="antiHcv"></div>
      <div id="urineGroup" class="form-group hidden"><label for="urine">Urine Lengkap:</label><textarea id="urine" rows="4"></textarea></div>
      <button id="saveBtn" class="hidden">Simpan Hasil Lab</button>
    </div>
  </div>

  <div class="patient-data-container">
    <div class="table-header">
      <h2 class="section-title">Data Hasil Lab Pasien</h2>
      <div class="search-container">
        <input type="search" id="searchInput" placeholder="Cari nama pasien...">
        <button id="searchButton">Cari</button>
      </div>
    </div>
  </div>

  <div id="hasilLabTable">
    <table>
      <thead>
        <tr>
          <th>Nama Pasien</th>
          <th>ID Pasien</th>
          <th>Tanggal Periksa</th>
          <th>Dokter Pengirim</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="hasilLabList"></tbody>
    </table>
  </div>

  <script>

    document.addEventListener("scroll", () => {
  const navbar = document.querySelector(".navigation-bar");
  if (window.scrollY > 50) {
    navbar.classList.add("scrolled");
  } else {
    navbar.classList.remove("scrolled");
  }
});
    const DOM = {
        pasienSelect: document.getElementById('pasienSelect'),
        pemeriksaanCheckboxes: document.querySelectorAll('#pemeriksaanList input[type="checkbox"]'),
        formInputContainer: document.getElementById('formInput'),
        saveBtn: document.getElementById('saveBtn'),
        searchInput: document.getElementById('searchInput'),
        searchButton: document.getElementById('searchButton'),
        tableBody: document.getElementById('hasilLabList'),
        inputHeader: document.getElementById('input-header')
    };

    function getAllPatients() {
        return JSON.parse(localStorage.getItem('pasienList')) || [];
    }

    function saveAllPatients(patients) {
        localStorage.setItem('pasienList', JSON.stringify(patients));
    }

    function filterPatientsByName(patients, searchTerm) {
        if (!searchTerm) return patients;
        return patients.filter(p => p.nama.toLowerCase().includes(searchTerm.toLowerCase()));
    }

    function renderTable(patients) {
        DOM.tableBody.innerHTML = "";
        const patientsWithLabResults = patients.filter(p => p.hasilLab && Object.keys(p.hasilLab).length > 0);
        if (patientsWithLabResults.length === 0) {
            DOM.tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Data tidak ditemukan.</td></tr>';
            return;
        }
        patientsWithLabResults.forEach(p => {
            const row = `<tr><td>${p.nama}</td><td>${p.id}</td><td>${p.tanggal || '-'}</td><td>${p.dokter_pengirim || '-'}</td><td><button onclick="handleEditClick(${p.id})">Edit</button><button onclick="printPasien(${p.id})">Cetak</button></td></tr>`;
            DOM.tableBody.innerHTML += row;
        });
    }

    function loadPasienDropdown() {
        const patients = getAllPatients();
        DOM.pasienSelect.innerHTML = '<option value="">--- Pilih Pasien ---</option>';
        patients.forEach(p => {
            const option = document.createElement("option");
            option.value = p.id;
            option.textContent = `${p.nama} (ID: ${p.id})`;
            DOM.pasienSelect.appendChild(option);
        });
    }

    function toggleSaveButton() {
        const isAnyChecked = Array.from(DOM.pemeriksaanCheckboxes).some(checkbox => checkbox.checked);
        DOM.saveBtn.classList.toggle('hidden', !isAnyChecked);
    }

    function toggleInput(groupId) {
        document.getElementById(groupId).classList.toggle("hidden");
    }

    function resetForm() {
        DOM.formInputContainer.querySelectorAll('input, textarea').forEach(input => input.value = '');
        DOM.pemeriksaanCheckboxes.forEach(checkbox => checkbox.checked = false);
        document.querySelectorAll('.form-group').forEach(group => group.classList.add('hidden'));
        toggleSaveButton();
    }

    function updateView() {
        const allPatients = getAllPatients();
        const searchTerm = DOM.searchInput.value;
        const filteredPatients = filterPatientsByName(allPatients, searchTerm);
        renderTable(filteredPatients);
    }

    function handleSaveLabData() {
        const allPatients = getAllPatients();
        const pasienId = parseInt(DOM.pasienSelect.value);
        if (isNaN(pasienId) || !pasienId) return alert("Silakan pilih pasien terlebih dahulu!");
        const pasienIndex = allPatients.findIndex(p => p.id === pasienId);
        if (pasienIndex === -1) return alert("Pasien tidak ditemukan!");
        let hasilLab = {};
        const fields = ["hemogoblin", "hematokrit", "leukosit", "eritrosit", "trombosit", "led", "retikulosit", "sgot", "sgpt", "bilirubin", "ureum", "creatinine", "HbsAG", "antiHbs", "antiHcv", "urine"];
        fields.forEach(field => {
            const group = document.getElementById(`${field}Group`);
            if (!group.classList.contains("hidden")) hasilLab[field] = document.getElementById(field).value || "-";
        });
        const { hemogoblin, hematokrit, eritrosit } = hasilLab;
        const hb = parseFloat(hemogoblin), ht = parseFloat(hematokrit), er = parseFloat(eritrosit);
        if (!isNaN(ht) && !isNaN(er) && er > 0) hasilLab.MCV = (ht * 10 / er).toFixed(2);
        if (!isNaN(hb) && !isNaN(er) && er > 0) hasilLab.MCH = (hb * 10 / er).toFixed(2);
        if (!isNaN(hb) && !isNaN(ht) && ht > 0) hasilLab.MCHC = (hb * 100 / ht).toFixed(2);
        allPatients[pasienIndex].hasilLab = hasilLab;
        saveAllPatients(allPatients);
        alert("Hasil lab berhasil diperbarui!");
        updateView();
        resetForm();
    }

    function handleEditClick(id) {
        resetForm();
        const allPatients = getAllPatients();
        const pasien = allPatients.find(p => p.id === id);
        if (!pasien) return alert("Data pasien tidak ditemukan!");
        DOM.pasienSelect.value = id;
        DOM.inputHeader.scrollIntoView({ behavior: 'smooth' });
        if (pasien.hasilLab) {
            for (const key in pasien.hasilLab) {
                if (pasien.hasilLab.hasOwnProperty(key)) {
                    const inputEl = document.getElementById(key), groupEl = document.getElementById(`${key}Group`), checkboxEl = document.querySelector(`input[onchange*="${key}Group"]`);
                    if (inputEl && groupEl && checkboxEl) {
                        inputEl.value = pasien.hasilLab[key];
                        groupEl.classList.remove('hidden');
                        checkboxEl.checked = true;
                    }
                }
            }
        }
        toggleSaveButton();
        alert(`Mode Edit untuk pasien "${pasien.nama}".\nData sebelumnya telah dimuat.`);
    }

    function printPasien(id) {
        window.open(`print.html?id=${id}`, "_blank");
    }

    function initializeEventListeners() {
        DOM.searchButton.addEventListener('click', updateView);
        DOM.searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') updateView();
        });
        DOM.saveBtn.addEventListener('click', handleSaveLabData);
    }

    function main() {
        loadPasienDropdown();
        initializeEventListeners();
        updateView();
    }

    document.addEventListener('DOMContentLoaded', main);
  </script>
</body>
</html>